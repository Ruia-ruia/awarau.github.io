---
layout: post
title: Linux kernel Use-After-Free (CVE-2021-23134) exploitation.
use_math: true
---

## The bug
The bug is a Use After Free (UAF) in the Near-Field-Communication (NFC) subsystem of the Linux kernel (before v5.12.4).

Let $S_i$ be a socket constructed with:

`socket(AF_NFC, SOCK_STREAM, NFC_SOCKPROTO_LLCP)`

Then suppose we bind $S_i$ to an address $A$.
$S_i$ will be loaded with a pointer to an object $L$ of type: `nfc_llcp_local`
However, if the bind fails for $S_i$ then $L$ will be freed while $S_i \to L$ remains defined. So a future computation which dereferences $S_i \to L$ will transition the kernel into a weird state.

The patch removes the pointer $S_i \to L$ when $L$ is freed on bind failure.
https://www.openwall.com/lists/oss-security/2021/05/11/4

## Exploitation
### Assumptions
`sysctl knob vm.unprivileged_userfaultfd=1`
and capability `CAP_NET_RAW` by default or through user namespaces.

### Strategy overview
The strategy is to leak and overwrite an object $R$ of type $io\_ring\_ctx$. By doing this, we can control the $sq\_creds$ field of $R$. Note that $R$’s type is chosen because objects of $R$’s and $L$’s types are similarly issued from kmalloc-2k.

$R \to sq\_creds replaces the current credentials of the submission queue poller thread when performing an $io\_uring$ request from userspace. If $sq\_creds$ points to a creds object $C$ such that $C$ has uid, gid, and so on set to $0$, then the kernel thread will perform I/O requests with root privileges.

We can therefore read or write files on disk as an unprivileged user by issuing such requests to the $io\_uring$ instance (managed by our controlled $R$). Our aim is to edit /etc/passwd so that we can enter a root shell.

### Components
We use the following components and techniques:

Three NFC sockets: S1, S2, and S3.
Six threads: main, X, Y, Z, T, and H. 
msgsnd + msgrcv allocation and free technique for leaking R. 
The userfaultfd + setxattr kernel blocking technique for writing to R and ensuring R is not reallocated by another thread during and after exploitation.

